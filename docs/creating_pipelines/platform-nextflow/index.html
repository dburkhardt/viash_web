<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://viash.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://viash.io/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=https://viash.io/main.7ef09754fd23774918bc5f9a4707f8ce1cccf79ce14d8825f4c7b40bc6085f58ee02e4b25ab9a7f84110a5f15ee1a0b9118fa2a08568017d6c1fa5c431168d1b.css integrity="sha512-fvCXVP0jd0kYvF+aRwf4zhzM95zhTYgl9Me0C8YIX1juAuSyWrmn+EEQpfFe4aC5EY+ioIVoAX1sH6XEMRaNGw==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Creating a Nextflow Pipeline - viash</title><meta name=description content="Developing a pipeline in Nextflow with Viash."><link rel=canonical href=https://viash.io/docs/creating_pipelines/platform-nextflow/><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/doks.png"><meta name=twitter:title content="Creating a Nextflow Pipeline"><meta name=twitter:description content="Developing a pipeline in Nextflow with Viash."><meta name=twitter:site content="@DataIntuitive"><meta name=twitter:creator content="@DataIntuitive"><meta property="og:title" content="Creating a Nextflow Pipeline"><meta property="og:description" content="Developing a pipeline in Nextflow with Viash."><meta property="og:type" content="article"><meta property="og:url" content="/docs/creating_pipelines/platform-nextflow/"><meta property="og:image" content="/doks.png"><meta property="article:published_time" content="2021-05-28T14:00:00+00:00"><meta property="article:modified_time" content="2021-06-22T08:41:57+00:00"><meta property="og:site_name" content="viash"><meta property="article:publisher" content="https://www.facebook.com/"><meta property="article:author" content="https://www.facebook.com/"><meta property="og:locale" content="en_US"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https:\/\/viash.io\/"},{"@type":"ListItem","position":3,"name":"Docs","item":"https:\/\/viash.io\/\/docs\/"},{"@type":"ListItem","position":4,"name":"Creating Pipelines","item":"https:\/\/viash.io\/\/docs\/creating_pipelines\/"},{"@type":"ListItem","position":5,"name":"Platform Nextflow","item":"https:\/\/viash.io\/\/docs\/creating_pipelines\/platform-nextflow\/"}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://viash.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://viash.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://viash.io/favicon-16x16.png><link rel=manifest href=https://viash.io/site.webmanifest><script async defer data-domain=viash.io src=https://plausible.io/js/plausible.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-GDS2XT0DDG"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-GDS2XT0DDG')</script></head><body class="docs single"><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://viash.io/>viash</a>
<button id=mode class="btn btn-link order-2 order-md-4" type=button aria-label="Toggle mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button><ul class="navbar-nav social-nav order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://twitter.com/DataIntuitive><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg><span class="ms-2 visually-hidden">Twitter</span></a></li><li class=nav-item><a class=nav-link href=https://github.com/viash-io/viash><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><span class="ms-2 visually-hidden">GitHub</span></a></li></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class="nav-item active"><a class=nav-link href=https://viash.io/docs/getting_started/introduction/>Docs</a></li><li class=nav-item><a class=nav-link href=https://viash.io/blog/>Blog</a></li></ul><div class="break order-6 d-md-none"></div><form class="navbar-form flex-grow-1 order-7 order-md-3"><input id=userinput class="form-control is-search" type=search placeholder="Search docs..." aria-label="Search docs..." autocomplete=off><div id=suggestions class="shadow bg-white rounded"></div></form></div></div></header><div class="wrap container" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar"><nav class=docs-links aria-label="Main navigation"><h3>Getting Started</h3><ul class=list-unstyled><li><a class=docs-link href=https://viash.io/docs/getting_started/introduction/>Introduction</a></li><li><a class=docs-link href=https://viash.io/docs/getting_started/installation/>Installation</a></li><li><a class=docs-link href=https://viash.io/docs/getting_started/what_is_a_viash_component/>What is a Viash Component?</a></li></ul><h3>Creating Viash Components</h3><ul class=list-unstyled><li><a class=docs-link href=https://viash.io/docs/creating_components/bash/>Creating a Bash Component</a></li><li><a class=docs-link href=https://viash.io/docs/creating_components/python/>Creating a Python Component</a></li><li><a class=docs-link href=https://viash.io/docs/creating_components/r/>Creating an R Component</a></li><li><a class=docs-link href=https://viash.io/docs/creating_components/supported_languages/>Supported Languages</a></li><li><a class=docs-link href=https://viash.io/docs/creating_components/file_formats/>Regarding File Formats</a></li></ul><h3>Managing Viash Projects</h3><ul class=list-unstyled><li><a class=docs-link href=https://viash.io/docs/projects/namespaces/>Namespaces</a></li></ul><h3>Creating Pipelines</h3><ul class=list-unstyled><li><a class="docs-link active" href=https://viash.io/docs/creating_pipelines/platform-nextflow/>Creating a Nextflow Pipeline</a></li></ul><h3>Running Components</h3><ul class=list-unstyled><li><a class=docs-link href=https://viash.io/docs/running/executables-docker/>Executables With a Docker Backend</a></li></ul><h3>Reference: Commands</h3><ul class=list-unstyled><li><a class=docs-link href=https://viash.io/docs/reference_commands/run/>viash run</a></li><li><a class=docs-link href=https://viash.io/docs/reference_commands/build/>viash build</a></li><li><a class=docs-link href=https://viash.io/docs/reference_commands/test/>viash test</a></li><li><a class=docs-link href=https://viash.io/docs/reference_commands/config-view/>viash config view</a></li><li><a class=docs-link href=https://viash.io/docs/reference_commands/ns-build/>viash ns build</a></li><li><a class=docs-link href=https://viash.io/docs/reference_commands/ns-test/>viash ns test</a></li><li><a class=docs-link href=https://viash.io/docs/reference_commands/ns-list/>viash ns list</a></li></ul><h3>Reference: Config</h3><ul class=list-unstyled><li><a class=docs-link href=https://viash.io/docs/reference_config/config/>Config File</a></li><li><a class=docs-link href=https://viash.io/docs/reference_config/functionality/>Functionality</a></li><li><a class=docs-link href=https://viash.io/docs/reference_config/platform-native/>Native Platform</a></li><li><a class=docs-link href=https://viash.io/docs/reference_config/platform-docker/>Docker Platform</a></li><li><a class=docs-link href=https://viash.io/docs/reference_config/platform-nextflow/>Nextflow Platform</a></li></ul><h3>Advanced Topics</h3><ul class=list-unstyled><li><a class=docs-link href=https://viash.io/docs/advanced/config_mods/>Dynamic Config Modding</a></li></ul><h3>Help</h3><ul class=list-unstyled><li><a class=docs-link href=https://viash.io/docs/help/frequently_asked_questions/>Frequently Asked Questions</a></li></ul><h3>Contributing</h3><ul class=list-unstyled><li><a class=docs-link href=https://viash.io/docs/contributing/guidelines/>Contributing Guidelines</a></li><li><a class=docs-link href=https://viash.io/docs/contributing/conduct/>Code of Conduct</a></li></ul></nav></div><nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a><ul><li><a href=#pipelines--workflows>Pipelines / Workflows</a></li><li><a href=#parallelization>Parallelization</a></li><li><a href=#output-filenames>Output Filenames</a></li></ul></li><li><a href=#tips>Tips</a><ul><li><a href=#how-to-specify-multiple-inputs>How to specify multiple inputs?</a></li></ul></li><li><a href=#multiple-outputs>Multiple outputs</a></li><li><a href=#access-arguments-from-the-nextflow-cli-v041>Access arguments from the <code>nextflow</code> CLI (<code>v0.4.1+</code>)</a></li></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9"><h1>Creating a Nextflow Pipeline</h1><p class=lead>Developing a Pipeline in Nextflow with Viash.</p><h2 id=introduction>Introduction<a href=#introduction class=anchor aria-hidden=true>#</a></h2><h3 id=pipelines--workflows>Pipelines / Workflows<a href=#pipelines--workflows class=anchor aria-hidden=true>#</a></h3><p>It’s possible to <em>convert</em> a Viash component into a NextFlow module.
Viash uses NextFlow’s DSL2 for this, effectively creating <em>modules</em> that
can be imported in a <code>main.nf</code> pipeline definition that deals with the
<em>logic</em> of the pipeline rather than the low-level machinery.</p><p>When it comes to this low-level machinery and the way Viash creates a
module, we refer to <a href=https://www.data-intuitive.com/diflow>the step-by-step introduction about
DiFlow</a>.</p><h3 id=parallelization>Parallelization<a href=#parallelization class=anchor aria-hidden=true>#</a></h3><p>NextFlow, as any other pipeline platform is able to run tasks in
parallel if the pipeline logic allows for that. In order to keep
different parallel branch unique, we add a unique identifier <code>id</code>. This
identifier can be a sample identifier, or a plate id (sequencing),
versions of reference files to consider, etc.</p><p>In a pipeline, one is often interested in running some computation on
different datasets, inputs or parts of an input. This means that
obviously we need to keep track of where the input chunks are located.
But more importantly, we can not just simply name an output file because
multiple parallel processes might just overwrite each other’s output
files.</p><h3 id=output-filenames>Output Filenames<a href=#output-filenames class=anchor aria-hidden=true>#</a></h3><p>Therefore, it’s important to keep output files distinct across different
steps of the pipeline but also between different parallel runs. In order
to assure this, a module will define its own output file name. It is
constructed from 3 ingredients:</p><ol><li>The unique <code>id</code> of the data going into the process</li><li>The name of the current component/task</li><li>An extension</li></ol><p>The extension is derived from the component configuration if a
<code>default: ...</code> attribute is present for the corresponding output
argument. If no such default value is provided, the <em>name</em> of the option
is used.</p><p>As an example, the following argument for a component <code>comp</code></p><pre><code class=language-yaml>name: --log
type: file
direction: Output
</code></pre><p>will result in <code>&lt;id>.comp.log</code>, while the following</p><pre><code class=language-yaml>name: --log
type: file
direction: Output
default: log.txt
</code></pre><p>will become in <code>&lt;id>.comp.txt</code>.</p><p>The config can define a directory as output as well, it will be named
accordingly.</p><p><strong>Remark</strong>: If the output is a directory, <code>type: file</code> should still be
used, but the corresponding script/code should take care of writing the
content to that directory.</p><h2 id=tips>Tips<a href=#tips class=anchor aria-hidden=true>#</a></h2><h3 id=how-to-specify-multiple-inputs>How to specify multiple inputs?<a href=#how-to-specify-multiple-inputs class=anchor aria-hidden=true>#</a></h3><p>If a component deals with just one input file, that input file should be
provided as the second element in the
<a href=https://www.data-intuitive.com/diflow/>DiFlow</a> triplet. In other
words, if this is the first component in a (sub)workflow, two options
are available:</p><pre><code class=language-groovy>Channel.fromPath(&lt;...&gt;).map{ file -&gt; [ &lt;id&gt;, file, params ] }
</code></pre><p>or</p><pre><code class=language-groovy>Channel.from(&lt;...&gt;).map{ filename -&gt; [ &lt;id&gt;, file(filename), params ] }
</code></pre><p>It is crucial that this second element in the triplet is of type <code>Path</code>.</p><p>If multiple inputs are to be provided corresponding to the same option
for the underlying process or tool a <code>List</code> of <code>Path</code> objects can be
provided.</p><p>For example, say we ran multiple parallel workflows for a single sample
and want to join the result of that. The way to express this in NextFlow
would be something like:</p><pre><code class=language-groovy>concatenate_ = singleSample_ \
    | toList \
    | map{ it -&gt; [ it.collect{ b -&gt; b[0]}, it.collect{ a -&gt; a[1] }, params ]} \
    | concatenate
</code></pre><p>In other words, we pass a <code>List</code> of Path objects to the concatenate
module.</p><p>In some cases, multiple input arguments deal with different input files,
for instance <code>fastq</code> files and a reference file for mapping and
counting. One can pass this to the concatenation module by means of a
<code>Map</code>. This approach, for instance can be used to merge meta information
(from a file) to an <code>h5ad</code> file:</p><pre><code class=language-groovy>    singleSample_ = input_ \
        ...
        | combine(meta_) \
        | map{ id, output, params, meta -&gt;
            [ id, [ &quot;input&quot; : output, &quot;meta&quot; : meta ], params ]
        } \
        | annotate
</code></pre><p>Where the <code>meta_</code> <code>Channel</code> points to the meta file to be used.</p><p>In other words, we either provide a <code>List</code> of Path values or in the case
multiple options take different files we use a <code>HashMap</code>.</p><p>Remark: Be sure to mark the arguments at hand as being of <code>type: file</code>
and <code>direction: input</code>.</p><h2 id=multiple-outputs>Multiple outputs<a href=#multiple-outputs class=anchor aria-hidden=true>#</a></h2><p>Internally, DiFlow uses a similar approach to keeping track of outputs
as discussed for inputs. What comes out of a module, however, is
slightly different. Since a <code>workflow</code> can not emit a multi-channel
object, we are forced to put all outputs on the same <code>Channel</code> and so we
use a <code>Map</code> again to distinguish both. This is only done for multiple
outputs, though.</p><p>By means of an example: Say a module outputs one file, then the triplet
that is returned from the module looks like this:</p><pre><code>[ &lt;id&gt;, file, params ]
</code></pre><p>If our tools has two output files, say for instance <code>outputfile.txt</code> and
<code>logfile.txt</code> (as indicated by the command line for the tool that looks
for instance like this:
<code>.... --output outputfile.txt --log logfile.txt</code>), we still get one
<code>Channel</code> back, but on that <code>Channel</code> there are now two <em>events</em> and
those look like this:</p><pre><code>[ &lt;id&gt;, [ output: outputfile.txt ], params ]
[ &lt;id&gt;, [ log: logfile.txt ], params ]
</code></pre><p>It’s up to the receiving end of the module to split this downstream. The
implicit workflow defined in all the generated module contains some
example code to that, for instance:</p><pre><code class=language-groovy>result \
  | filterOutput \
  | view{ &quot;Output for output: &quot; + it[1] }

result \
  | filterLog \
  | view{ &quot;Output for log: &quot; + it[1] }
</code></pre><p>Where the <code>filterLog</code> process for instance is defined like so:</p><pre><code>// A process that filters out output from the output Map
process filterOutput {

  input:
    tuple val(id), val(input), val(_params)
  output:
    tuple val(id), val(output), val(_params)
  when:
    input.keySet().contains(&quot;output&quot;)
  exec:
    output = input[&quot;output&quot;]

}
</code></pre><p>Alternatively, one could also use methods on the <code>Channel</code> itself:</p><pre><code>result \
  | filter{ it[1].keySet().contains(&quot;output&quot;) }
  | map{ [ it[0], it[1][&quot;output&quot;], it[2] ] }
  | view{ &quot;Output for log: &quot; + it[1] }
</code></pre><p>One more option is to use the <code>branch</code> or <code>multiMap</code> <code>Channel</code> forking
operators in NextFlow.</p><h2 id=access-arguments-from-the-nextflow-cli-v041>Access arguments from the <code>nextflow</code> CLI (<code>v0.4.1+</code>)<a href=#access-arguments-from-the-nextflow-cli-v041 class=anchor aria-hidden=true>#</a></h2><p>We provide a way to access the argument values for all the arguments for
every component from the NextFlow CLI. All components store their
respective arguments under a component-specific key that corresponds to
the component name.</p><p>Furthermore, the value that will effectively be passed to the process
depends on the following attributes for an argument:</p><pre><code class=language-yaml>required: true/false
default: ...
</code></pre><p>If an argument is <code>required: true</code>, it can have</p><ul><li>a <code>default: ...</code> value: It will use this default value on the CLI
unless you override it on the CLI</li><li>no default value: In this case, one has to provide a value when
starting a NextFlow pipeline. Otherwise Viash will give a warning
and NXF will throw an error.</li></ul><p>If an argument is <code>required: false</code>, it can have</p><ul><li><code>a default: ...</code> value: It will use this default value unless you
override it from the CLI</li><li>no default value: In this case, this argument will not be present on
the CLI, but it can still be overridden from the CLI</li></ul><p>Please refer to <a href=https://github.com/viash-io/viash/issues/46>this
issue</a> for more
information.</p><p>Given the above, its possible to override any of these using the
following scheme:</p><pre><code>--&lt;component_name&gt;__&lt;argument_name&gt; &lt;value&gt;
</code></pre><p>For instance:</p><pre><code>nextflow run main.nf --filter__threshold 0.2
</code></pre><p class=edit-page><a href=https://github.com/viash-io/viash_web/blob/master/content/docs/creating_pipelines/platform-nextflow.md><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Edit this page on GitHub</a></p><div class="docs-navigation d-flex justify-content-between"><a href=https://viash.io/docs/reference_commands/run/><div class="card my-1"><div class="card-body py-2">&larr; viash run</div></div></a><a class=ms-auto href=https://viash.io/docs/reference_commands/build/><div class="card my-1"><div class="card-body py-2">viash build &rarr;</div></div></a></div></main></div></div></div><footer class="footer text-muted"><div class=container><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a href=https://www.netlify.com/>Netlify</a>, <a href=https://gohugo.io/>Hugo</a>, and <a href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script src=https://viash.io/js/highlight.min.e9c91f500c2172569be7d2a727b68f1ce1c9fb16db9f9136b70a760db5566f6e819facc04ac0e6bdf7ba4055c4d56f9fd1b87434992707a767ba098210c66f8c.js integrity="sha512-6ckfUAwhclab59KnJ7aPHOHJ+xbbn5E2twp2DbVWb26Bn6zASsDmvfe6QFXE1W+f0bh0NJknB6dnugmCEMZvjA==" crossorigin=anonymous defer></script><script src=https://viash.io/main.min.cb1cfa565384689404329cbf8ad4a175b59ac6421a528ad947882d8242fc7b62b773cd5967a10349256154f6a67bcdeeb3da0729191ddd4f5623442999e53004.js integrity="sha512-yxz6VlOEaJQEMpy/itShdbWaxkIaUorZR4gtgkL8e2K3c81ZZ6EDSSVhVPame83us9oHKRkd3U9WI0QpmeUwBA==" crossorigin=anonymous defer></script><script src=https://viash.io/index.min.b724d79f04c8575f653da6aa8fe1dbd036fd52eff0285196a21e2794169f3e7930f201e2e66cd2190d4526e78109fd4bc196acfb87b776522a1128d8b57a0104.js integrity="sha512-tyTXnwTIV19lPaaqj+Hb0Db9Uu/wKFGWoh4nlBafPnkw8gHi5mzSGQ1FJueBCf1LwZas+4e3dlIqESjYtXoBBA==" crossorigin=anonymous defer></script></body></html>